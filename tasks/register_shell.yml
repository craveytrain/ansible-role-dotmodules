---
# Register shell in /etc/shells if declared by module
# Feature: 001-register-shell-support
# Feature: 001-optional-shell-registration (adds skip_shell_registration support)
# Feature: 002-runtime-skip-shell-registration (adds --skip-tags register_shell support)
# This task is invoked by process_module.yml when a module declares register_shell
#
# Edge Cases Handled:
# - register_shell undefined: Task skipped (no error)
# - register_shell empty string: Task skipped (length check)
# - register_shell whitespace-only: Task skipped (length check)
# - Multiple modules with same shell: lineinfile provides idempotency
# - Absolute path: Used as-is (no prefix detection)
# - Shell binary doesn't exist: Registration proceeds (mirrors macOS behavior)
# - skip_shell_registration true: Registration skipped, debug message shown
# - skip_shell_registration undefined: Defaults to false (registration enabled, backward compatible)

# Only proceed if register_shell is defined and non-empty
- name: Check if register_shell is defined
  ansible.builtin.set_fact:
    _register_shell_defined: '{{ module_config.ansible_facts.register_shell is defined and module_config.ansible_facts.register_shell | length > 0 }}'

# Check if shell registration should be skipped (Feature: 001-optional-shell-registration)
- name: Check if skip_shell_registration is enabled
  ansible.builtin.set_fact:
    _skip_registration: '{{ module_config.ansible_facts.skip_shell_registration | default(false) | bool }}'

# The remaining tasks run conditionally based on _register_shell_defined and _skip_registration

- name: Detect Homebrew prefix based on architecture
  ansible.builtin.set_fact:
    # Architecture detection for Homebrew path:
    # - arm64 (Apple Silicon M1/M2/M3): /opt/homebrew
    # - x86_64 (Intel Mac): /usr/local
    homebrew_prefix: "{{ '/opt/homebrew' if ansible_machine == 'arm64' else '/usr/local' }}"
  when: _register_shell_defined and not _skip_registration
  tags:
    - register_shell

- name: Resolve shell path (handle both shell names and absolute paths)
  ansible.builtin.set_fact:
    shell_path: >-
      {{
        module_config.ansible_facts.register_shell
        if '/' in module_config.ansible_facts.register_shell
        else homebrew_prefix + '/bin/' + module_config.ansible_facts.register_shell
      }}
  when: _register_shell_defined and not _skip_registration
  tags:
    - register_shell

- name: Shell registration skipped by configuration
  ansible.builtin.debug:
    msg: "Shell registration skipped by configuration (skip_shell_registration: true)"
  when: _register_shell_defined and _skip_registration

- name: Attempt shell registration with error handling
  block:
    - name: Register shell in /etc/shells
      ansible.builtin.lineinfile:
        path: /etc/shells
        line: '{{ shell_path }}'
        state: present
        create: yes
        mode: '0644'
      become: yes
  rescue:
    - name: Provide helpful error message on registration failure
      ansible.builtin.fail:
        msg: |
          Failed to register {{ shell_path }} in /etc/shells.

          This is usually caused by:
          - Insufficient sudo privileges
          - System policies preventing /etc/shells modification

          To skip shell registration, add to your module's config.yml:
          skip_shell_registration: true
  when: _register_shell_defined and not _skip_registration
  tags:
    - register_shell
