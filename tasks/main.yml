---
- name: Determine if dotmodules.repo is a local path
  set_fact:
    dotmodules_repo_local: "{{ dotmodules.repo is match('^(file://|/).*') }}"

- name: Remove file:// prefix if present
  set_fact:
    dotmodules_repo_path: "{{ dotmodules.repo | regex_replace('^file://', '') }}"
  when: dotmodules_repo_local

- name: Clone or update dotmodules repository (remote)
  ansible.builtin.git:
    repo: "{{ dotmodules.repo }}"
    dest: "{{ dotmodules.dest }}"
    version: "main"
    force: yes
  when: not dotmodules_repo_local

- name: Link dotmodules folder (for testing)
  ansible.builtin.file:
    src: "{{ dotmodules_repo_path }}"
    dest: "{{ dotmodules.dest }}"
    state: link
  when: dotmodules_repo_local

# Set home directory (allow override for testing)
- name: Set home directory
  ansible.builtin.set_fact:
    home_dir: "{{ home_dir | default(lookup('env', 'HOME')) }}"

# Initialize aggregated configurations
- name: Initialize aggregated module configurations
  ansible.builtin.set_fact:
    stow_dirs: []
    collected_configs: {}

- name: Process each dotmodule in the install list
  ansible.builtin.include_tasks: process_module.yml
  loop: "{{ dotmodules.install }}"
  loop_control:
    loop_var: module_name

# Initialize final_config
- name: Initialize final_config
  ansible.builtin.set_fact:
    final_config: {}

# Convert collected_configs to a list of key-value pairs
- name: Convert collected configurations to key-value pairs
  ansible.builtin.set_fact:
    collected_items: >-
      {{
        collected_configs | dict2items
        | map(attribute='value') | list
        | map('dict2items') | sum(start=[])
      }}

# Deduplicate list-based values and detect conflicts for scalar values
- name: Reduce collected configurations
  ansible.builtin.set_fact:
    final_config: >-
      {{
        final_config | default({}) | combine({
          item.key: (
            ((final_config | default({}))[item.key] | default([]) + item.value) | flatten | unique
            if item.value is iterable and item.value is not string and item.value is not mapping
            else item.value
          )
        }, recursive=True)
      }}
  loop: "{{ collected_items | default([]) }}"

# Note: Conflict detection for scalar values is handled in the Reduce collected configurations task
# If different modules specify different scalar values for the same key, the last one wins

- name: Debug final_config contents
  ansible.builtin.debug:
    var: ansible_facts

# Set reasonable defaults
- name: Override geerling.mac defaults
  ansible.builtin.set_fact:
    homebrew_taps: []
    mas_installed_apps: []

# Promote each variable from the combined config into a host variable
- name: Set combined facts
  ansible.builtin.set_fact:
    "{{ item.key }}": "{{ item.value }}"
  loop: "{{ final_config | default({}) | dict2items }}"

# Ensure stow_dirs is set (from final_config or default to all installed modules)
- name: Initialize stow_dirs from final_config or default to all modules
  ansible.builtin.set_fact:
    stow_dirs: "{{ stow_dirs | default(dotmodules.install | default([])) }}"

# Resolve file strategy conflicts first
- name: Resolve file strategy conflicts
  ansible.builtin.include_tasks: conflict_resolution.yml
  when: dotmodules.install | length > 0

# Handle mergeable files
- name: Process mergeable files
  ansible.builtin.include_tasks: merge_files.yml
  when: dotmodules.install | length > 0

# Run Stow once for all modules (excluding mergeable files)
- name: Deploy all dotfiles using stow
  ansible.builtin.include_tasks: stow_module.yml
  loop: "{{ stow_dirs }}"
  loop_control:
    loop_var: module_name
  when: stow_dirs | length > 0

# Install git repositories (before Homebrew to ensure dependencies are available)
- name: Ensure configured git repositories are installed
  ansible.builtin.git:
    repo: "{{ item.repo }}"
    dest: "{{ item.dest | expanduser }}"
    version: "{{ item.version | default('master') }}"
    update: "{{ item.update | default(true) | bool }}"
    force: "{{ item.force | default(false) | bool }}"
    recursive: "{{ item.recursive | default(true) | bool }}"
  loop: "{{ git_repositories | default([]) }}"
  when: git_repositories is defined and git_repositories | length > 0
  loop_control:
    label: "{{ item.repo }} -> {{ item.dest }}"

# Run Homebrew installation once for all modules
- name: Run Mac App Store installation for all modules using the collection
  ansible.builtin.include_role:
    name: "geerlingguy.mac.mas"
  when: >
    final_config | default({}) | dict2items
    | selectattr('key', 'match', '^mas_')
    | list | length > 0

# Run Homebrew installation using direct modules (no sudo required)
- name: Ensure configured Homebrew taps are tapped
  community.general.homebrew_tap:
    tap: "{{ item }}"
    state: present
  loop: "{{ homebrew_taps | default([]) }}"
  when: homebrew_taps is defined and homebrew_taps | length > 0

- name: Ensure configured Homebrew packages are installed
  community.general.homebrew:
    name: "{{ item }}"
    state: present
  loop: "{{ homebrew_packages | default([]) }}"
  when: homebrew_packages is defined and homebrew_packages | length > 0

- name: Install configured Homebrew casks
  community.general.homebrew_cask:
    name: "{{ item }}"
    state: present
    accept_external_apps: yes
  loop: "{{ homebrew_casks | default([]) }}"
  when: homebrew_casks is defined and homebrew_casks | length > 0
